(function(){function w(f,b,a){var c=f[b];f[b]=f[a];f[a]=c}var ba,C=0,M=1,J=2,K=3,N=4,E=5,F=6,G=7,H=8,O=9,P=10,Q=11,R=12,f=14,m=15,t=16,n=17,I=18,ca=19,S=20,T=21,z=22,x=23,U=24,v=25,L=26,V=27,A=28,W=29,X=30,r=function(f){var b=this;Object.keys(f).forEach(function(a){b[a]=f[a]})};r.prototype={toString:function(){return JSON.stringify(this)}};var ea=function(f,b){this.old=f;this["new"]=b};ea.prototype={contains:function(f){return f.length<this.length?f["new"]>=this["new"]&&f["new"]<this["new"]+this.length:
!1},toString:function(){return this.length+" element subset, first mapping: old "+this.old+" \u2192 new "+this["new"]}};var ga=function b(a,c,d){if(!a||!c||a.nodeType!==c.nodeType)return!1;if(3===a.nodeType)return 3!==c.nodeType?!1:d?!0:a.data===c.data;if(a.nodeName!==c.nodeName||a.childNodes.length!==c.childNodes.length)return!1;for(var e=!0,f=a.childNodes.length-1;0<=f;f--)e=d?e&&a.childNodes[f].nodeName===c.childNodes[f].nodeName:e&&b(a.childNodes[f],c.childNodes[f],!0);return e},Y=function(b){var a=
b.cloneNode(!0),c,d,e;if(8!=b.nodeType&&3!=b.nodeType){c=b.querySelectorAll("textarea");d=a.querySelectorAll("textarea");for(e=0;e<c.length;e++)d[e].value!==c[e].value&&(d[e].value=c[e].value);b.value&&b.value!==a.value&&(a.value=b.value);c=b.querySelectorAll("option");d=a.querySelectorAll("option");for(e=0;e<c.length;e++)c[e].selected&&!d[e].selected?d[e].selected=!0:!c[e].selected&&d[e].selected&&(d[e].selected=!1);b.selected&&!a.selected?a.selected=!0:!b.selected&&a.selected&&(a.selected=!1)}return a},
B=function(b){var a={},c;if(3===b.nodeType)a[U]=b.data;else if(8===b.nodeType)a[V]=b.data;else{a[L]=b.nodeName;if(b.attributes&&0<b.attributes.length)for(a[v]=[],c=0;c<b.attributes.length;c++)a[v].push([b.attributes[c].name,b.attributes[c].value]);if(b.childNodes&&0<b.childNodes.length)for(a[A]=[],c=0;c<b.childNodes.length;c++)a[A].push(B(b.childNodes[c]));b.value&&(a[x]=b.value);b.checked&&(a[W]=b.checked);b.selected&&(a[X]=b.selected)}return a},da=function(b,a){var c,d;if(b.hasOwnProperty(U))c=
document.createTextNode(b[U]);else if(b.hasOwnProperty(V))c=document.createComment(b[V]);else{"svg"===b[L]||a?(c=document.createElementNS("http://www.w3.org/2000/svg",b[L]),a=!0):c=document.createElement(b[L]);if(b[v])for(d=0;d<b[v].length;d++)c.setAttribute(b[v][d][0],b[v][d][1]);if(b[A])for(d=0;d<b[A].length;d++)c.appendChild(da(b[A][d],a));b[x]&&(c.value=b[x]);b[W]&&(c.checked=b[W]);b[X]&&(c.selected=b[X])}return c},Z=function(b,a){var c=function(a){a.slice();for(var b=0,f=a.length;b<f;b++)a[b]instanceof
Array&&(a[b]=c(a[b]))};a instanceof Array&&(a=c(a));return Array(b).join(".").split(".").map(function(){return a})},ha=function(b,a,c){var d=Z(b.childNodes.length,!0),e=Z(a.childNodes.length,!0),f=0;c.forEach(function(a){var b,c;b=a.old;for(c=b+a.length;b<c;b++)d[b]=f;b=a["new"];for(c=b+a.length;b<c;b++)e[b]=f;f++});return{gaps1:d,gaps2:e}},fa=function(){this.list=[]};fa.prototype={list:!1,add:function(b){var a=this.list;b.forEach(function(b){a.push(b)})},forEach:function(b){this.list.forEach(b)}};
var aa=function(b,a){"undefined"===typeof b?b=!1:(C="add attribute",M="modify attribute",J="remove attribute",K="modify text element",N="relocate group",E="remove element",F="add element",G="remove text element",H="add text element",O="replace element",P="modify value",Q="modify checked",R="modify selected",f="action",m="route",t="oldValue",n="newValue",I="element",ca="group",S="from",T="to",z="name",x="value",U="text",v="attributes",L="nodeName",V="comment",A="childNodes",W="checked",X="selected");
"undefined"===typeof a&&(a=10);this.debug=b;this.diffcap=a};aa.prototype={diff:function(b,a){ba=0;b=Y(b);a=Y(a);this.debug&&(this.t1Orig=B(b),this.t2Orig=B(a));this.tracker=new fa;return this.findDiffs(b,a)},findDiffs:function(b,a){do{if(this.debug&&(ba++,ba>this.diffcap))throw window.diffError=[this.t1Orig,this.t2Orig],Error("surpassed diffcap:"+JSON.stringify(this.t1Orig)+" -> "+JSON.stringify(this.t2Orig));if(difflist=this.findFirstDiff(b,a,[]))difflist.length||(difflist=[difflist]),this.tracker.add(difflist),
this.apply(b,difflist)}while(difflist);return this.tracker.list},findFirstDiff:function(b,a,c){var d=this.findOuterDiff(b,a,c);if(0<d.length)return d;if(b=this.findInnerDiff(b,a,c))if("undefined"===typeof b.length&&(b=[b]),0<b.length)return b;return!1},findOuterDiff:function(b,a,c){var d;if(b.nodeName!=a.nodeName)return d={},d[f]=O,d[t]=B(b),d[n]=B(a),d[m]=c,[new r(d)];d=Array.prototype.slice;var e=function(a,b){return a.name>b.name},q=b.attributes?d.call(b.attributes).sort(e):[],g=a.attributes?d.call(a.attributes).sort(e):
[],k=[];(b.value||a.value)&&b.value!==a.value&&"OPTION"!==b.nodeName&&(d={},d[f]=P,d[t]=b.value,d[n]=a.value,d[m]=c,k.push(new r(d)));(b.checked||a.checked)&&b.checked!==a.checked&&(d={},d[f]=Q,d[t]=b.checked,d[n]=a.checked,d[m]=c,k.push(new r(d)));q.forEach(function(a){var b;a:{b=0;for(var d=g.length;b<d;b++)if(g[b].name===a.name)break a;b=-1}if(-1===b)return b={},b[f]=J,b[m]=c,b[z]=a.name,b[x]=a.value,k.push(new r(b)),k;d=g.splice(b,1)[0];a.value!==d.value&&(b={},b[f]=M,b[m]=c,b[z]=a.name,b[t]=
a.value,b[n]=d.value,k.push(new r(b)))});b.attributes||b.data===a.data||(d={},d[f]=13,d[m]=c,d[t]=b.data,d[n]=a.data,k.push(new r(d)));if(0<k.length)return k;g.forEach(function(a){var b;b={};b[f]=C;b[m]=c;b[z]=a.name;b[x]=a.value;k.push(new r(b))});if((b.selected||a.selected)&&b.selected!==a.selected){if(0<k.length)return k;d={};d[f]=R;d[t]=b.selected;d[n]=a.selected;d[m]=c;k.push(new r(d))}return k},findInnerDiff:function(b,a,c){var d,e=a;d=Y(b);e=Y(e);d=d.childNodes;for(var q=e.childNodes,g=Z(d.length,
!1),k=Z(q.length,!1),e=[],l=!0,p;l;){p=d;for(var h=q,w=g,z=k,l=0,v=[],A=p.length,C=h.length,D=[],u=void 0,y=u=void 0,u=0;u<A+1;u++)D[u]=[];for(u=0;u<A;u++)for(y=0;y<C;y++)w[u]||z[y]||!ga(p[u],h[y])?D[u+1][y+1]=0:(D[u+1][y+1]=D[u][y]?D[u][y]+1:1,D[u+1][y+1]>l&&(l=D[u+1][y+1],v=[u+1,y+1]));0===l?l=!1:(p=[v[0]-l,v[1]-l],p=new ea(p[0],p[1]),p.length=l,l=p);if(l){e.push(l);for(p=0;p<l.length;p++)g[l.old+p]=!0;for(p=0;p<l.length;p++)k[l["new"]+p]=!0}}d=e.length;if(0===d&&3===b.nodeType&&3===a.nodeType&&
b.data!==a.data)return e={},e[f]=K,e[t]=b.data,e[n]=a.data,e[m]=c,new r(e);if(2>d)for(d=0,q=Math.max(b.childNodes.length,a.childNodes.length);d<q;d++){g=b.childNodes[d];k=a.childNodes[d];if(g&&!k){if(3===g.nodeType)return e={},e[f]=G,e[m]=c.concat(d),e[x]=g.data,new r(e);e={};e[f]=E;e[m]=c.concat(d);e[I]=B(g);return new r(e)}if(k&&!g){if(3===k.nodeType)return e={},e[f]=H,e[m]=c.concat(d),e[x]=k.data,new r(e);e={};e[f]=F;e[m]=c.concat(d);e[I]=B(k);return new r(e)}if(3!=g.nodeType||3!=k.nodeType)if(l=
this.findOuterDiff(g,k,c.concat(d)),0<l.length)return l;if(g=this.findInnerDiff(g,k,c.concat(d)))return g}return this.findFirstInnerDiff(b,a,e,c)},findFirstInnerDiff:function(b,a,c,d){if(0===c.length)return!1;for(var e=ha(b,a,c),q=e.gaps1,g=q.length,k=e.gaps2,l=q.length,p,h,v=g<l?g:l,e=0,v=(g<l?q:k).length;e<v;e++){if(!0===q[e]){b=b.childNodes[e];if(3===b.nodeType){if(3===a.childNodes[e].nodeType&&b.data!=a.childNodes[e].data){for(c=b;c.nextSibling&&3===c.nextSibling.nodeType;)if(c=c.nextSibling,
a.childNodes[e].data===c.data){h=!0;break}if(!h)return h={},h[f]=K,h[m]=d.concat(e),h[t]=b.data,h[n]=a.childNodes[e].data,new r(h)}h={};h[f]=G;h[m]=d.concat(e);h[x]=b.data;return new r(h)}h={};h[f]=E;h[m]=d.concat(e);h[I]=B(b);return new r(h)}if(!0===k[e]){b=a.childNodes[e];if(3===b.nodeType)return h={},h[f]=H,h[m]=d.concat(e),h[x]=b.data,new r(h);h={};h[f]=F;h[m]=d.concat(e);h[I]=B(b);return new r(h)}if(q[e]!=k[e]&&(g=c[q[e]],l=Math.min(g["new"],b.childNodes.length-g.length),l!=e)){var w=!1;for(p=
0;p<g.length;p++)b.childNodes[l+p].isEqualNode(b.childNodes[e+p])||(w=!0);if(w)return h={},h[f]=N,h[ca]=g,h[S]=e,h[T]=l,h[m]=d,new r(h)}}return!1},apply:function(b,a){var c=this;"undefined"===typeof a.length&&(a=[a]);if(0===a.length)return!0;a.forEach(function(a){if(!c.applyDiff(b,a))return!1});return!0},getFromRoute:function(b,a){a=a.slice();for(var c,d=b;0<a.length;){if(!d.childNodes)return!1;c=a.splice(0,1)[0];d=d.childNodes[c]}return d},textDiff:function(b,a,c,d){b.data=d},applyDiff:function(b,
a){var c=this.getFromRoute(b,a[m]);if(a[f]===C){if(!c||!c.setAttribute)return!1;c.setAttribute(a[z],a[x])}else if(a[f]===M){if(!c||!c.setAttribute)return!1;c.setAttribute(a[z],a[n])}else if(a[f]===J){if(!c||!c.removeAttribute)return!1;c.removeAttribute(a[z])}else if(a[f]===P){if(!c||"undefined"===typeof c.value)return!1;c.value=a[n]}else if(13===a[f]){if(!c||"undefined"===typeof c.data)return!1;c.data=a[n]}else if(a[f]===Q){if(!c||"undefined"===typeof c.checked)return!1;c.checked=a[n]}else if(a[f]===
R){if(!c||"undefined"===typeof c.selected)return!1;c.selected=a[n]}else if(a[f]===K){if(!c||3!=c.nodeType)return!1;this.textDiff(c,c.data,a[t],a[n])}else if(a[f]===O){var d=da(a[n]);c.parentNode.replaceChild(d,c)}else if(a[f]===N){var d=a[ca],e=a[S],q=a[T],g;g=c.childNodes[q+d.length];if(e<q)for(var k=0;k<d.length;k++)q=c.childNodes[e],c.insertBefore(q,g);else for(g=c.childNodes[q],k=0;k<d.length;k++)q=c.childNodes[e+k],c.insertBefore(q,g)}else if(a[f]===E)c.parentNode.removeChild(c);else if(a[f]===
G){if(!c||3!=c.nodeType)return!1;c.parentNode.removeChild(c)}else if(a[f]===F)c=a[m].slice(),g=c.splice(c.length-1,1)[0],c=this.getFromRoute(b,c),d=da(a[I]),g>=c.childNodes.length?c.appendChild(d):(g=c.childNodes[g],c.insertBefore(d,g));else if(a[f]===H){c=a[m].slice();g=c.splice(c.length-1,1)[0];d=document.createTextNode(a[x]);c=this.getFromRoute(b,c);if(!c||!c.childNodes)return!1;g>=c.childNodes.length?c.appendChild(d):(g=c.childNodes[g],c.insertBefore(d,g))}return!0},undo:function(b,a){a=a.slice();
var c=this;a.length||(a=[a]);a.reverse();a.forEach(function(a){c.undoDiff(b,a)})},undoDiff:function(b,a){a[f]===C?(a[f]=J,this.applyDiff(b,a)):a[f]===M?(w(a,t,n),this.applyDiff(b,a)):a[f]===J?(a[f]=C,this.applyDiff(b,a)):a[f]===K?(w(a,t,n),this.applyDiff(b,a)):a[f]===P?(w(a,t,n),this.applyDiff(b,a)):13===a[f]?(w(a,t,n),this.applyDiff(b,a)):a[f]===Q?(w(a,t,n),this.applyDiff(b,a)):a[f]===R?(w(a,t,n),this.applyDiff(b,a)):a[f]===O?(w(a,t,n),this.applyDiff(b,a)):a[f]===N?(w(a,S,T),this.applyDiff(b,a)):
a[f]===E?(a[f]=F,this.applyDiff(b,a)):a[f]===F?(a[f]=E,this.applyDiff(b,a)):a[f]===G?(a[f]=H,this.applyDiff(b,a)):a[f]===H&&(a[f]=G,this.applyDiff(b,a))}};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=aa),exports.diffDOM=aa):this.diffDOM=aa}).call(this);
